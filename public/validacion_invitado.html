<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmación de asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- CSS Común + Personalizado -->
  <link rel="stylesheet" href="/css/common.css" />
  <link rel="stylesheet" href="/css/validacion_invitado.css" />
</head>

<body class="bg-white text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">
  <!-- Formulario de confirmación -->
  <form id="confirm-form" class="w-full max-w-md bg-gray-100 p-6 rounded shadow">
    <label for="name-input" class="block text-lg font-semibold mb-2">
      Escribe tu Nombre y Apellido:
    </label>

    <input type="text" id="name-input" class="w-full p-2 border border-gray-300 rounded mb-4" />

    <p id="error-message" class="text-red-600 text-sm mb-4"></p>

    <!-- Contenedor para mostrar sugerencias -->
    <div id="sugerencias" class="mt-4 space-y-2"></div>

    <button type="submit" class="w-full text-white py-2 rounded transition" style="background-color:#8c6117;" onmouseover="this.style.backgroundColor='#724e12';">
      Ir a Confirmación
    </button>
  </form>

  <!-- JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('confirm-form');
      const input = document.getElementById('name-input');
      const error = document.getElementById('error-message');
      const sugerenciasDiv = document.getElementById('sugerencias');

      const formularios = {
        1: { url: 'https://forms.gle/wAZvgTQNhXVamq2DA', entry: 'entry.1079611635' },
        2: { url: 'https://forms.gle/3pCM7HNyEcXcLpex8', entry: 'entry.859038236' },
        3: { url: 'https://forms.gle/Yxbcc9zczJ325TYm6', entry: 'entry.939276153' }
      };

      const normalizar = (str) =>
        str
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\w\s]/gi, "")
          .trim();

      let dataCSV = [];

      async function cargarCSV() {
        const response = await fetch('/invitados/invitados.csv');
        const texto = await response.text();
        const lineas = texto.split('\n').map(l => l.trim()).slice(1);

        dataCSV = lineas.map(linea => {
          const [nombre, cantidadStr] = linea.split(';').map(s => s.trim());
          return {
            original: nombre,
            normalizado: normalizar(nombre),
            partes: normalizar(nombre).split(' '),
            cantidad: parseInt(cantidadStr)
          };
        });
      }

      function mostrarSugerencias(opciones) {
        sugerenciasDiv.innerHTML = '';
        if (opciones.length === 0) {
          error.textContent = 'No se encontraron coincidencias.';
          return;
        }

        error.textContent = 'Selecciona tu nombre:';
        opciones.forEach(op => {
          const btn = document.createElement('button');
          btn.textContent = op.original;
          btn.className = 'block w-full bg-gray-200 hover:bg-gray-300 rounded p-2';
          btn.onclick = () => redirigirAFormulario(op);
          sugerenciasDiv.appendChild(btn);
        });
      }

      function redirigirAFormulario(invitado) {
        const formConfig = formularios[invitado.cantidad];
        if (formConfig) {
          const nombreEncoded = encodeURIComponent(invitado.original);
          const redireccion = `${formConfig.url}?${formConfig.entry}=${nombreEncoded}`;
          window.parent.location.href = redireccion;
        } else {
          error.textContent = `No hay formulario configurado para ${invitado.cantidad} pase(s).`;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        error.textContent = '';
        sugerenciasDiv.innerHTML = '';

        const nombreIngresado = normalizar(input.value);
        const partesIngresadas = nombreIngresado.split(' ');

        if (!dataCSV.length) await cargarCSV();

        const coincidencias = dataCSV.filter(dato =>
          partesIngresadas.every(palabra =>
            dato.partes.includes(palabra)
          )
        );

        if (coincidencias.length === 1) {
          redirigirAFormulario(coincidencias[0]);
        } else if (coincidencias.length > 1) {
          mostrarSugerencias(coincidencias);
        } else {
          error.textContent = 'Nombre no encontrado en la lista.';
        }
      });
    });
  </script>
</body>
</html>
